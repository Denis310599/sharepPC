FROM ubuntu:latest

RUN apt-get update -y


# Instalo todo el entorno npm, la app y todas las dependencias
RUN apt-get install -y ca-certificates fonts-liberation libatk-bridge2.0-0 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 lsb-release wget xdg-utils libxtst-dev libx11-dev

RUN apt install curl -y

RUN curl -fsSL https://deb.nodesource.com/setup_21.x | bash -

RUN apt-get update -y
RUN apt-get upgrade -y

RUN apt-get install nodejs -y

WORKDIR /usr

RUN mkdir test

WORKDIR /usr/test

COPY shared /usr/shared

RUN cp /usr/shared/webrtc_linux_ssh/package.json /usr/test/package.json

RUN apt update -y 
RUN apt-get install -y build-essential
RUN apt-get install -y libpng-dev

RUN npm install ws --en-dev
RUN npm install patch-package --en-dev
RUN npm install @roamhq/wrtc --en-dev

WORKDIR /usr

RUN cp -r shared/webrtc_linux_ssh/src test/src

#Instalo sshd
RUN apt-get update && apt-get install -y openssh-server
# Set root password for SSH access
RUN echo 'root:root' | chpasswd
RUN sed 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config -i
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd

RUN mkdir /var/run/sshd
EXPOSE 22

#RUN mv test/src/package.json test

# Copia el script de inicio dentro del contenedor
# COPY run.sh /usr/local/bin/run.sh

# Establece los permisos de ejecuci√≥n para el script
#RUN chmod +x /usr/local/bin/run.sh

# Define el comando a ejecutar cuando se inicie el contenedor
CMD   /usr/sbin/sshd -D; node /usr/test/src/app.js;